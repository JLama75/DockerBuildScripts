Bootstrap: docker
From: public.ecr.aws/ubuntu/ubuntu:22.04

%labels
    Author "Jyoti Lama"
    Version "1.0"
    Description "Singularity container for QC pipeline: Regenie + dependencies"

%post
    #--------------------------------
    # Non-interactive mode and timezone
    #--------------------------------
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/New_York
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
    echo $TZ > /etc/timezone

    #--------------------------------
    # Update system and install basic dependencies
    #--------------------------------
    apt-get update && apt-get upgrade -y
    apt-get install -y --no-install-recommends \
        tzdata build-essential wget curl unzip git python3 python3-pip \
        r-base r-base-dev libcurl4-openssl-dev libssl-dev libxml2-dev \
        perl cpanminus openjdk-11-jre-headless ca-certificates locales \
        bzip2 libbz2-dev liblzma-dev zlib1g-dev gcc g++ gfortran make \
        libgomp1 \
    && rm -rf /var/lib/apt/lists/*

    #--------------------------------
    # Set locale
    #--------------------------------
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8

    #--------------------------------
    # Python packages
    #--------------------------------
    python3 -m pip install --upgrade pip
    python3 -m pip install \
        seaborn==0.13.2 \
        plotly==6.1.2 \
        matplotlib==3.9.4 \
        scikit-learn==1.6.1 \
        statsmodels==0.14.4 \
        xlsxwriter==3.2.3 \
        pysnptools==0.5.13 \
        nextflow==25.04.4

    #--------------------------------
    # R packages
    #--------------------------------
    Rscript -e "install.packages(c('dplyr','ggplot2','qqman','data.table','stringr','ggExtra','gridExtra','optparse','devtools'), repos='https://cloud.r-project.org')"

    #--------------------------------
    # Perl packages
    #--------------------------------
    cpanm Bio::Perl

    #--------------------------------
    # Install HTSlib
    #--------------------------------
    HTSLIB_VERSION=1.18
    mkdir -p /tmp/src && cd /tmp/src
    wget https://github.com/samtools/htslib/releases/download/$HTSLIB_VERSION/htslib-$HTSLIB_VERSION.tar.bz2
    tar -xf htslib-$HTSLIB_VERSION.tar.bz2
    cd htslib-$HTSLIB_VERSION
    ./configure
    make
    make install
    cd ..

    #--------------------------------
    # Install CMake
    #--------------------------------
    CMAKE_VERSION_MAJOR=3.13
    CMAKE_VERSION_MINOR=0
    wget http://cmake.org/files/v${CMAKE_VERSION_MAJOR}/cmake-${CMAKE_VERSION_MAJOR}.${CMAKE_VERSION_MINOR}-Linux-x86_64.sh -O cmake_install.sh
    sh cmake_install.sh --prefix=/usr/local --skip-license --exclude-subdir
    rm cmake_install.sh

    #--------------------------------
    # Install BGEN library
    #--------------------------------
    wget http://code.enkre.net/bgen/tarball/release/v1.1.7 -O v1.1.7.tgz
    tar -xzf v1.1.7.tgz
    rm v1.1.7.tgz
    cd v1.1.7
    python3 waf configure
    python3 waf
    cd ..

    #--------------------------------
    # Build Regenie
    #--------------------------------
    git clone https://github.com/rgcgithub/regenie.git /tmp/src/regenie
    cd /tmp/src/regenie
    BGEN_PATH=/tmp/src/v1.1.7 HTSLIB_PATH=/usr/local/lib cmake .
    make
    cp regenie /usr/local/bin/

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PIPELINE_DIR=/data/QCpipeline/work

%runscript
    exec "$@"
